# -*- mode: ruby -*-
# vi: set ft=ruby :

Vagrant.configure(2) do |config|

  config.vm.box = "https://github.com/kohkimakimoto/vagrantboxes/releases/download/centos6.6/centos-6.6-x86_64.box"
  config.vm.hostname = "gluassh-test-server"
  config.vm.network :private_network, ip:"192.168.56.81"

  pub_key = File.read(__dir__ + '/keys/id_rsa.nopass.pub')
  pub_key2 = File.read(__dir__ + '/keys/id_rsa.pass.pub')

  config.vm.provision :shell, :inline => <<-EOT

# packages
    yum install -y \
      man \
      curl \
      vim-enhanced \
      unzip \
      git

#
# user1 "user_keynopass" (ssh key without passphrase)
#
    useradd user_keynopass
    passwd -f -u user_keynopass
    mkdir -p /home/user_keynopass/.ssh
    chown user_keynopass:user_keynopass /home/user_keynopass/.ssh
    chmod 700 /home/user_keynopass/.ssh
    cat > /home/user_keynopass/.ssh/authorized_keys <<EOF
#{pub_key}
EOF
    chown user_keynopass /home/user_keynopass/.ssh/authorized_keys;
    chmod 600 /home/user_keynopass/.ssh/authorized_keys
    echo "user_keynopass    ALL=(ALL)		NOPASSWD: ALL" >> /etc/sudoers

#
# user2 "user_keypass" (ssh key with passphrase)
#
    useradd user_keypass
    passwd -f -u user_keypass
    mkdir -p /home/user_keypass/.ssh
    chown user_keypass:user_keypass /home/user_keypass/.ssh
    chmod 700 /home/user_keypass/.ssh

    cat > /home/user_keypass/.ssh/authorized_keys <<EOF
#{pub_key2}
EOF
    chown user_keypass /home/user_keypass/.ssh/authorized_keys;
    chmod 600 /home/user_keypass/.ssh/authorized_keys
    echo "user_keypass    ALL=(ALL)		NOPASSWD: ALL" >> /etc/sudoers

#
# user3 "user_passwordauth" (ssh password auth) password is "testpassword"
#
    useradd user_passwordauth
    echo testpassword | passwd user_passwordauth --stdin
    echo "user_passwordauth    ALL=(ALL)		NOPASSWD: ALL" >> /etc/sudoers

#
# user4 "user_keynopass_sudopass" (ssh key without passphrase. sudo requires password)
#
    useradd user_keynopass_sudopass
    echo testpassword | passwd user_keynopass_sudopass --stdin
    mkdir -p /home/user_keynopass_sudopass/.ssh
    chown user_keynopass_sudopass:user_keynopass_sudopass /home/user_keynopass_sudopass/.ssh
    chmod 700 /home/user_keynopass_sudopass/.ssh

    cat > /home/user_keynopass_sudopass/.ssh/authorized_keys <<EOF
#{pub_key}
EOF
    chown user_keynopass_sudopass /home/user_keynopass_sudopass/.ssh/authorized_keys;
    chmod 600 /home/user_keynopass_sudopass/.ssh/authorized_keys
    echo "user_keynopass_sudopass    ALL=(ALL)		ALL" >> /etc/sudoers

  EOT

  config.vm.provider :virtualbox do |vb|
    vb.gui = false
    vb.customize ["modifyvm", :id, "--memory", "512"]
  end

end